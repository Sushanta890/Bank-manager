<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Aadhaar QR & OTP</title>

<style>
body{
    font-family: Arial;
    background:#eef3ff;
    padding:20px;
}
.box{
    width:380px;
    margin:auto;
    padding:20px;
    background:white;
    border-radius:10px;
    box-shadow:0 0 10px #aaa;
}
input{
    width:100%;
    padding:10px;
    margin-top:10px;
    border-radius:5px;
    border:1px solid #888;
}
button{
    width:100%;
    padding:10px;
    margin-top:10px;
    background:#0b63d1;
    border:none;
    color:white;
    font-size:16px;
    border-radius:5px;
    cursor:pointer;
}
#details, #qrSection{
    display:none;
    margin-top:15px;
}
#qrcode{
    text-align:center;
    margin-top:10px;
}
#qrcode img{
    display:block;
    margin:auto;
}
#userPhoto{
    display:block;
    width:100px;
    height:100px;
    margin:auto;
    border-radius:50%;
    margin-bottom:10px;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

</head>
<body>

<h2 align="center">Aadhaar OTP & QR Code Generator</h2>

<div class="box">

    <h3>Step 1: Enter Aadhaar Number</h3>
    <input id="aadharInput" placeholder="Enter Aadhaar Number" maxlength="12">

    <button onclick="findUser()">Find Aadhaar Data</button>

    <div id="details">
        <h3>Step 2: OTP Verification</h3>
        <p><b>OTP Sent:</b> <span id="otpShow"></span></p>
        <input id="otpInput" placeholder="Enter OTP">

        <button onclick="verifyOTP()">Verify OTP</button>
    </div>

    <div id="qrSection">
        <h3 align="center">Your Aadhaar QR Code</h3>
        <img id="userPhoto" src="" alt="User Photo">
        <div id="qrcode"></div>

        <button onclick="downloadQR()">Download QR Code</button>
        <button onclick="window.print()">Print</button>
    </div>

</div>

<script>

let foundUser = null;
let generatedOTP = null;

// Step 1 – Find User by Aadhaar Number
function findUser(){
    let aadhar = aadharInput.value.trim();

    if(aadhar.length !== 12){
        alert("Enter valid 12 digit Aadhaar number");
        return;
    }

    foundUser = null;

    // SEARCH ALL localStorage KEYS
    for(let i=0; i<localStorage.length; i++){
        let key = localStorage.key(i);
        let data = JSON.parse(localStorage.getItem(key));

        if(data.aadhar == aadhar){
            foundUser = data;
            break;
        }
    }

    if(!foundUser){
        alert("Aadhaar not found!");
        return;
    }

    // Show user photo
    document.getElementById("userPhoto").src = foundUser.photo || "";

    // Generate OTP
    generatedOTP = Math.floor(100000 + Math.random()*900000);
    document.getElementById("otpShow").innerText = generatedOTP;

    document.getElementById("details").style.display = "block";
}

// Step 2 – Verify OTP and Generate QR Code
function verifyOTP(){
    if(otpInput.value != generatedOTP){
        alert("Incorrect OTP!");
        return;
    }

    // FULL DETAILS FOR QR CODE (photo included as base64)
    let qrText =
`Aadhaar Number: ${foundUser.aadhar}
Name: ${foundUser.fname} ${foundUser.lname}
Gender: ${foundUser.gender}
Mobile: ${foundUser.mobile}
DOB: ${foundUser.dob}

Address:
Village: ${foundUser.village}
District: ${foundUser.district}
State: ${foundUser.state}
Country: ${foundUser.country}
PIN: ${foundUser.pin}

Photo(Base64): ${foundUser.photo || "N/A"}
`;

    // Clear previous QR code
    document.getElementById("qrcode").innerHTML = "";

    // Generate new QR code
    new QRCode(document.getElementById("qrcode"),{
        text: qrText,
        width:180,
        height:180
    });

    document.getElementById("qrSection").style.display = "block";

    // Save QR text in localStorage under Aadhaar number
    localStorage.setItem(foundUser.aadhar+"_qr", qrText);
    console.log("QR data saved to localStorage for Aadhaar:", foundUser.aadhar);
}

// Download QR Code
function downloadQR(){
    let img = document.querySelector("#qrcode img");
    if(!img) { alert("Generate QR Code first!"); return; }

    let link = document.createElement("a");
    link.href = img.src;
    link.download = "Aadhaar_QR.png";
    link.click();
}

</script>

</body>
</html>
